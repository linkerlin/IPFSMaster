# 研发计划（IPFSMaster）

> 目标：构建一个纯 PHP 本地 Web App，为本地运行的 Kubo（IPFS 节点）提供更好 UI 操作体验；使用 SQLite；PHP 原生模板渲染；Bootstrap 5；局部更新使用 htmx；导入文件/文件夹/CID 后自动递归 pin；默认 RPC 与网关配置可改。

## 1. 目标与范围

### 1.1 核心目标
- 提供可视化、易用、美观的 IPFS 管理界面。
- 只使用 PHP 原生渲染 + htmx 局部更新（不引入前后端分离）。
- SQLite 本地存储，便于部署与迁移。
- 导入文件/文件夹/CID 后自动递归 pin，保障数据持久。
- 默认 Kubo RPC 与网关自动探测/可配置。

### 1.2 MVP 范围
- 主页仪表盘：节点状态、版本、Peer 数、仓库容量。
- 浏览：IPFS 目录/文件浏览与网关预览。
- Pin 管理：列表、状态、递归 pin、取消 pin。
- 上传：文件/文件夹上传并自动 pin。
- 设置：RPC 与网关配置、自动探测。

### 1.3 非目标（暂不做）
- 用户登录/权限系统。
- 多节点管理。
- 大规模集群监控。

## 2. 需求拆解

### 2.1 功能需求
1. **节点连接**
   - 读取配置（RPC URL / Gateway URL）。
   - RPC 连接健康检测。
   - 网关可用性检测与自动回退（8080 → 8081 → 8082）。

2. **上传与导入**
   - 上传文件/文件夹到 IPFS。
   - 通过 CID 导入（远程/本地已有）。
   - 上传后保存记录（名称、CID、大小、时间、来源）。

3. **自动递归 pin**
   - 上传/导入后自动递归 pin。
   - 记录 pin 结果与失败原因。

4. **浏览与预览**
   - 通过 CID 浏览目录树。
   - 通过网关预览文件。

5. **Pin 管理**
   - 列表查看 pin 状态。
   - 一键取消 pin。
   - 过滤（递归/直接）。

6. **系统设置**
   - RPC 与网关地址可编辑。
   - 连接测试按钮。
   - 默认值回滚。

### 2.2 非功能需求
- **性能**：避免不必要的 RPC 请求；缓存基础状态。
- **稳定性**：RPC 超时/错误提示清晰。
- **美观**：Bootstrap 5 美化 UI，统一布局。
- **安全**：文件上传限制与 MIME 校验；避免路径注入。

## 3. 技术方案

### 3.1 架构
- **public/index.php**：单入口。
- **Router**：基础路由分发。
- **Controller**：处理请求并渲染模板。
- **Model**：IPFSClient、Database。
- **Templates**：布局 + 页面。

### 3.2 数据库（SQLite）
- 表：`pins`、`uploads`、`settings`。
- 推荐字段：
  - `pins`：id, cid, type, recursive, status, created_at, last_check
  - `uploads`：id, name, cid, size, source, created_at
  - `settings`：key, value

### 3.3 IPFS RPC 接口
- `/api/v0/id`：节点信息。
- `/api/v0/stats/bw`：带宽与流量。
- `/api/v0/stats/repo`：仓库状态。
- `/api/v0/pin/add?recursive=true`：递归 pin。
- `/api/v0/pin/ls`：pin 列表。
- `/api/v0/pin/rm`：取消 pin。
- `/api/v0/add`：上传文件。

## 4. 阶段计划

### Phase 1：需求梳理与基线确认（1 天）
- 评审 AGENTS.md 需求。
- 明确 RPC/网关默认值及回退策略。
- 确定数据表结构。

### Phase 2：核心后端能力（2 天）
- 完善 `IPFSClient`：RPC 请求、超时处理、错误封装。
- 完善 `Database`：SQLite 初始化与迁移。
- 增强设置读取与更新。

### Phase 3：MVP 界面（2 天）
- Dashboard：节点状态与统计。
- Upload：上传并自动 pin。
- Pins：pin 列表 + 取消。
- Browse：CID 目录浏览。

### Phase 4：htmx 局部更新（1 天）
- Dashboard 指标轮询。
- Pins 列表刷新。
- Upload 结果异步更新。

### Phase 5：优化与收尾（1 天）
- 错误提示与日志记录。
- UI 美化（Bootstrap 组件统一）。
- 文档更新（README）。

## 5. 风险与对策

| 风险 | 影响 | 对策 |
|---|---|---|
| RPC 不可用 | 主要功能失效 | 增加连接测试与重试提示 |
| 大文件上传超时 | 上传失败 | 增加大小限制与分片提示 |
| pin 递归失败 | 数据丢失风险 | 记录失败原因并可手动重试 |

## 6. 交付物

- 研发计划文档（本文件）。
- 代码实现与基础 UI。
- README 更新。

## 7. 里程碑验收标准

- 能成功连接 Kubo RPC。
- 上传文件/文件夹后自动递归 pin。
- Pins 列表可显示并支持取消。
- 页面美观、可用、无明显报错。

## 8. 下一步行动

✅ 完成 - 校验现有代码结构与路由实现细节。
✅ 完成 - 制定具体改动清单（控制器、模板、模型）。
✅ 完成 - 进入开发阶段。
✅ 完成 - 核心功能实现与优化。
✅ 完成 - 测试覆盖（单元测试、集成测试、边界测试、性能测试、安全测试）。

## 9. 已完成功能清单

### 核心功能
- ✅ IPFS 节点连接与健康检测
- ✅ 文件上传与自动 Pin
- ✅ 文件夹导入与批量 Pin
- ✅ CID 导入与递归 Pin
- ✅ Pin 列表管理（查看、删除、同步）
- ✅ IPFS 内容浏览（目录树、文件预览）
- ✅ 网关配置与自动回退
- ✅ RPC 配置与多地址格式支持

### UI/UX
- ✅ 响应式 Bootstrap 5 界面
- ✅ htmx 局部更新（无刷新体验）
- ✅ 实时数据刷新（仪表盘统计）
- ✅ 华丽渐变主题
- ✅ 动画与交互效果

### 数据管理
- ✅ SQLite 数据库初始化
- ✅ Pin 记录持久化
- ✅ 导入历史记录
- ✅ 系统配置管理

### 测试覆盖
- ✅ 单元测试（12 个测试类）
- ✅ 集成测试（数据库操作）
- ✅ 边界测试（异常处理）
- ✅ 性能测试（查询、解析）
- ✅ 安全测试（XSS、SQL注入防护）

### 文档
- ✅ README 更新
- ✅ 测试文档
- ✅ 部署指南